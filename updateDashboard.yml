---
- name: Update Wazuh Dashboard to match API version
  hosts: all
  become: yes
  tasks:
    # Task 1: Kiểm tra xem Wazuh Dashboard đã được cài đặt chưa
    - name: Check if Wazuh Dashboard is installed
      shell: dpkg-query --showformat='${Status}' -W wazuh-dashboard
      register: wazuh_dashboard_check
      ignore_errors: yes

    - name: Display Wazuh Dashboard installation status
      debug:
        msg: >
          {% if wazuh_dashboard_check.stdout == "install ok installed" %}
          Wazuh Dashboard is installed.
          {% else %}
          Wazuh Dashboard is not installed. It will be installed now.
          {% endif %}

    # Task 2: Cập nhật cache APT
    - name: Update apt cache
      apt:
        update_cache: yes

    # Task 3: Cài đặt hoặc cập nhật Wazuh Dashboard lên phiên bản mới nhất
    - name: Install or update Wazuh Dashboard
      apt:
        name: wazuh-dashboard
        state: latest

    # Task 4: Khởi động lại dịch vụ Wazuh Dashboard
    - name: Restart Wazuh Dashboard service
      service:
        name: wazuh-dashboard
        state: restarted

    # Task 5: Kiểm tra phiên bản Dashboard sau cập nhật
    - name: Check Wazuh Dashboard version
      shell: wazuh-dashboard version
      register: wazuh_dashboard_version
      ignore_errors: yes

    - name: Display Wazuh Dashboard version
      debug:
        msg: >
          {% if wazuh_dashboard_version.stdout %}
          Wazuh Dashboard has been updated to version: {{ wazuh_dashboard_version.stdout }}.
          {% else %}
          Unable to retrieve Wazuh Dashboard version. Please check manually.
          {% endif %}
